const LEFT_BOUND=28.5,RIGHT_BOUND=571.5,UPPER_BOUND=0,LOWER_BOUND=800,RADIUS_POW2_2X=1625;var touchTarget=null,leftArrowIsDown=!1,rightArrowIsDown=!1,touchDownTime=0,mouseDown=!1,showLocus=!1,isPaused=!1;function shotCurBall(){if(null!=curBall){null!=shotSfx&&(curBall.ballType==BALL_BOMB?4==shotSfx.readyState&&shotSfx.play():4==ballSounds[curBall.colorIndex].readyState&&ballSounds[curBall.colorIndex].play()),shotBall=curBall,shotBall.x=curBallRect.left+32,shotBall.y=curBallRect.top+32,shotBall.velocity.x=Math.sin(angle)*BALL_VELOCITY,shotBall.velocity.y=-Math.cos(angle)*BALL_VELOCITY,curBall=nextBall;var t=getAvailableColors();j=Math.floor(Math.random()*t.length);let l=BALL_REGULAR;var e=Math.random();e<BALL_BOMB_PROBABILITY?l=BALL_BOMB:e<BALL_PLUS5_PROBABILITY&&(l=BALL_PLUS5),nextBall=new Ball(0,0,t[j],l),gameState=BALL_GOING}}function detectBallCollision(){let l=shotBall.x+shotBall.velocity.x*msecsPerFrame;var o=shotBall.y+shotBall.velocity.y*msecsPerFrame;l<LEFT_BOUND?l=LEFT_BOUND:l>RIGHT_BOUND&&(l=RIGHT_BOUND);for(let e=LAST_ROW_INDEX;0<=e;--e)for(let t=0;t<BALL_COLS;++t)if(null!=ballArr[e][t]){var a=ballArr[e][t],r=l-a.x,n=o-a.y;if(r*r+n*n<RADIUS_POW2_2X){if(colliXY.x=a.x,colliXY.y=a.y,0<r){let l=Math.atan2(n,r);null!=dbg_span&&(dbg_span.innerHTML="incident angle = "+l.toString()),l<.785&&t<LAST_COL_INDEX&&null==ballArr[e][t+1]?(shotBall.row=e,shotBall.col=t+1):(shotBall.row=e+1,e%2==1?shotBall.col=t+1:shotBall.col=t,null!=ballArr[shotBall.row][shotBall.col]&&++shotBall.row)}else{let l=Math.atan2(n,-r);null!=dbg_span&&(dbg_span.innerHTML="incident angle = "+l.toString()),l<.785&&0<t&&null==ballArr[e][t-1]?(shotBall.row=e,shotBall.col=t-1):(shotBall.row=e+1,e%2==1?shotBall.col=t:shotBall.col=t-1,null!=ballArr[shotBall.row][shotBall.col]&&++shotBall.row)}return shotBall.row<BALL_ROWS&&(ballArr[shotBall.row][shotBall.col]=shotBall,shotBall.getXYByRowCol()),!0}}return shotBall.y<BALL_HALF_HEIGHT&&(shotBall.y=BALL_HALF_HEIGHT,shotBall.row=0,shotBall.col=Math.floor(shotBall.x/BALL_WIDTH),shotBall.x=shotBall.col*BALL_WIDTH+BALL_HALF_WIDTH,ballArr[shotBall.row][shotBall.col]=shotBall,!0)}onKeyDown=function(l){l.preventDefault(),"ArrowLeft"==l.code?leftArrowIsDown=!0:"ArrowRight"==l.code&&(rightArrowIsDown=!0),requestRender=!0},onKeyUp=function(l){var t;l.preventDefault(),"ArrowLeft"==l.code?leftArrowIsDown=!1:"ArrowRight"==l.code?rightArrowIsDown=!1:"ArrowDown"==l.code?gameState==AIMING&&(t=curBall,curBall=nextBall,nextBall=t,requestRender=!0):"Space"==l.code?gameState==AIMING&&shotCurBall():"KeyL"==l.code?0==showLocus?showLocus=!0:(showLocus=!1,locus.length=0):null!=dbg_span&&"KeyP"==l.code&&(0==isPaused?isPaused=!0:requestRender=!(isPaused=!1))},onTouch=function(l){var t,e,o,a;"touchcancel"!=l.type?0!=(o=l.changedTouches).length&&(t=o[0].clientX-touchTarget.offsetLeft,a=o[0].clientY-touchTarget.offsetTop,e=(curBallRect.left+BALL_HALF_WIDTH)*densityX,a<(o=(curBallRect.top+BALL_HALF_HEIGHT)*densityY)&&(e=t-e,o=o-a,angle=Math.PI/2-Math.atan2(o,e),angle<ANGLE_MIN&&(angle=ANGLE_MIN),angle>ANGLE_MAX&&(angle=ANGLE_MAX),requestRender=!0),"touchstart"==l.type?touchDownTime=Date.now():"touchend"==l.type&&(gameState==AIMING&&Date.now()-touchDownTime<TAPPING_MSECS&&(l.preventDefault(),curBallRect.bottom*densityY<a?(a=curBall,curBall=nextBall,nextBall=a,requestRender=!0):shotCurBall()),touchDownTime=0)):touchDownTime=0},onMouse=function(l){if("mousedown"==l.type)touchDownTime=Date.now(),mouseDown=!0;else if("mousemove"==l.type&&0==mouseDown)return;var t,e=l.clientX-touchTarget.offsetLeft,o=l.clientY-touchTarget.offsetTop,a=(curBallRect.left+BALL_HALF_WIDTH)*densityX,r=(curBallRect.top+BALL_HALF_HEIGHT)*densityY;o<r&&(t=e-a,r=r-o,angle=Math.PI/2-Math.atan2(r,t),angle<ANGLE_MIN&&(angle=ANGLE_MIN),angle>ANGLE_MAX&&(angle=ANGLE_MAX),requestRender=!0),"mouseup"==l.type&&(gameState==AIMING&&Date.now()-touchDownTime<TAPPING_MSECS&&(t=curBallRect.bottom*densityY,1==l.which?t<o?(o=curBall,curBall=nextBall,nextBall=o,requestRender=!0):shotCurBall():3==l.which&&(l=curBall,curBall=nextBall,nextBall=l,requestRender=!0)),touchDownTime=0,mouseDown=!1),requestRender=!0};