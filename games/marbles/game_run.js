var curLevel=1,curBonus=0,curScore=0;const PREPARING=0,AIMING=1,BALL_GOING=2,STOPPED=3;var gameState=0,curLevelMsecs=0,preparingMsecs=0,explosionMsecs=0,exploCentre=new ivec2(0,0),gameTimerID=0,curDate=0,angle=0,shotBall=null,curBall=null,curBallRect=newRectXYWH(270,820,BALL_WIDTH,BALL_HEIGHT),nextBall=null,nextBallRect=newRectXYWH(515,925,BALL_WIDTH,BALL_HEIGHT),fallingBalls=[],lastTimerSecs=60,gameIsOver=!1;function onUpdate(){var e;oldDate=curDate,curDate=Date.now(),0==isPaused&&updateBalls(curDate-oldDate),1==requestRender&&(e=getBackBufferContext(),drawBalls(e),swapBuffers())}function showScoreMessageBox(e,l){let t=document.getElementById("msg_title");t.innerHTML=e,t=document.getElementById("msg_bonus"),t.innerHTML=STR_TIME_BONUS+": "+curBonus,t=document.getElementById("msg_total"),t.innerHTML=STR_TOTAL_SCORE+": "+curScore;let a=document.getElementById("cont_button");a.innerHTML=l,a.style.display="inline-block";let s=document.getElementById("message_box");s.style.display="block"}function getWeightedScore(l){let t=POINTS_PER_BALL*l,a=POINTS_PER_BALL;for(let e=4;e<=l;++e)t+=a,a*=POINTS_INCREMENT;return Math.floor(t)}function updateBalls(a){if(0<explosionMsecs&&(explosionMsecs-=a)<0&&(explosionMsecs=0),leftArrowIsDown&&((angle-=DELTA_ANGLE_PER_FRAME)<ANGLE_MIN&&(angle=ANGLE_MIN),requestRender=!0),rightArrowIsDown&&((angle+=DELTA_ANGLE_PER_FRAME)>ANGLE_MAX&&(angle=ANGLE_MAX),requestRender=!0),0<fallingBalls.length){let t=!0;for(let l=0;l<fallingBalls.length;++l)if(null!=fallingBalls[l]){let e=fallingBalls[l];e.y+=BALL_FALLING_PER_MSEC*a,e.y<LOWER_BOUND?(e.fallingMsecs-=a,e.fallingMsecs<0?fallingBalls[l]=null:t=!1):fallingBalls[l]=null}1==t&&(fallingBalls.length=0)}if(gameState==PREPARING){if((preparingMsecs-=a)<=0){let e=document.getElementById("message_box");e.style.display="none";let l=document.getElementById("arena");l.focus(),gameState=AIMING,requestRender=!(preparingMsecs=0)}}else if(gameState==AIMING){(curLevelMsecs-=a)<0&&(curLevelMsecs=0);var t=Math.ceil(curLevelMsecs/1e3);if(t!=lastTimerSecs){let e=document.getElementById("time_label");e.innerHTML="TIME: "+t,lastTimerSecs=t}if(0==curLevelMsecs)return gameIsOver=!0,gameState=STOPPED,fallingBalls.length=0,null!=gameOverSfx&&4==gameOverSfx.readyState&&gameOverSfx.play(),void showScoreMessageBox(STR_GAME_OVER,STR_FINISH);requestRender=!0}else if(gameState==BALL_GOING){(curLevelMsecs-=a)<0&&(curLevelMsecs=0);var s=Math.ceil(curLevelMsecs/1e3);if(s!=lastTimerSecs){let e=document.getElementById("time_label");e.innerHTML="TIME: "+s,lastTimerSecs=s}if(0==curLevelMsecs)return gameIsOver=!0,gameState=STOPPED,fallingBalls.length=0,requestRender=!(shotBall=null),null!=gameOverSfx&&4==gameOverSfx.readyState&&gameOverSfx.play(),void showScoreMessageBox(STR_GAME_OVER,STR_FINISH);if(shotBall.x+=shotBall.velocity.x*a,shotBall.y+=shotBall.velocity.y*a,shotBall.x<LEFT_BOUND?(shotBall.x=LEFT_BOUND,shotBall.velocity.x=-shotBall.velocity.x):shotBall.x>RIGHT_BOUND&&(shotBall.x=RIGHT_BOUND,shotBall.velocity.x=-shotBall.velocity.x),1==detectBallCollision()){let l=0;if(gameState=AIMING,shotBall.ballType==BALL_BOMB){let e=getNeighbors(shotBall.row,shotBall.col);e.push(shotBall),l=e.length,deleteBallCluster(e,!1),explosionMsecs=BOMB_EXPLOSION_MSECS,exploCentre=new ivec2(shotBall.x,shotBall.y),null!=explodeSfx&&4==explodeSfx.readyState&&explodeSfx.play()}else{t=findCluster(shotBall,!0);2<t.length?(l=t.length,deleteBallCluster(t,!0),null!=glassSfx&&4==glassSfx.readyState&&glassSfx.play()):null!=collideSfx&&4==collideSfx.readyState&&collideSfx.play()}if(0<l){markRootClusters();let t=[];for(let l=0;l<BALL_ROWS;++l)for(let e=0;e<BALL_COLS;++e)null!=ballArr[l][e]&&0==clusteredArr[l][e]&&t.push(ballArr[l][e]);0<t.length&&(l+=t.length,deleteBallCluster(t,!0)),curScore+=getWeightedScore(l);let e=document.getElementById("score_label");e.innerHTML="SCORE: "+curScore;let a=!0;for(let l=0;l<BALL_ROWS;++l){for(let e=0;e<BALL_COLS;++e)if(null!=ballArr[l][e]){a=!1;break}if(0==a)break}1==a&&(curBonus=POINTS_PER_SEC*s,curScore+=curBonus,fallingBalls.length=0,gameState=STOPPED,null!=succeedSfx&&4==succeedSfx.readyState&&succeedSfx.play(),curLevel<stage_arr.length?showScoreMessageBox(STR_CONGRATULATIONS,STR_NEXT_STAGE):(gameIsOver=!0,showScoreMessageBox(STR_CONGRATULATIONS,STR_FINISH)))}if(gameState==AIMING)for(let e=0;e<BALL_COLS;++e)if(null!=ballArr[LAST_ROW_INDEX][e]){fallingBalls.length=0,gameIsOver=!0,gameState=STOPPED,null!=gameOverSfx&&4==gameOverSfx.readyState&&gameOverSfx.play(),showScoreMessageBox(STR_GAME_OVER,STR_FINISH);break}shotBall=null}requestRender=!0}else shotBall=null}function onContinueClicked(){if(1==gameIsOver){var e=itoc(curScore);return e+=charMap[Math.floor(36*Math.random())],e+=charMap[Math.floor(36*Math.random())],void window.location.assign(BILLBOARD_URL+"?g="+e)}let l=document.getElementById("message_box");l.style.display="none",curLevel<stage_arr.length&&++curLevel,prepareCurStage()}